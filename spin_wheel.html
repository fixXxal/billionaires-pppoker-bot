<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Free Spins Wheel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .spins-info {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            font-size: 1.2em;
            backdrop-filter: blur(10px);
        }

        .wheel-container {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 0 auto 30px;
        }

        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid white;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            position: relative;
            overflow: hidden;
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            padding: 10px;
        }

        .pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #FFD700;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
            z-index: 10;
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .spin-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            border-radius: 50px;
            padding: 18px 45px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .spin-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .spin-button:active {
            transform: scale(0.98);
        }

        .spin-button:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .prize-list {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            color: white;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            text-align: left;
        }

        .prize-list h3 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .prize-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 400px) {
            .wheel-container {
                width: 300px;
                height: 300px;
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ FREE SPINS üé∞</h1>

        <div class="spins-info" id="spinsInfo">
            Loading...
        </div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <div id="wheel"></div>
            <div class="center-circle">üé≤</div>
        </div>

        <button class="spin-button" id="spinBtn" onclick="spinWheel()">SPIN NOW!</button>

        <div class="result" id="result" style="display:none;"></div>

        <div class="prize-list">
            <h3>üéÅ Prize Wheel</h3>
            <div class="prize-item">üèÜ 500 Chips (Jackpot!)</div>
            <div class="prize-item">üí∞ 250 Chips</div>
            <div class="prize-item">üíé 100 Chips</div>
            <div class="prize-item">üíµ 50 Chips</div>
            <div class="prize-item">ü™ô 20 Chips</div>
            <div class="prize-item">üéØ 10 Chips</div>
            <div class="prize-item">üì± iPhone 17 Pro Max</div>
            <div class="prize-item">üíª MacBook Pro</div>
            <div class="prize-item">‚åö Apple Watch Ultra</div>
            <div class="prize-item">üéß AirPods Pro</div>
        </div>
    </div>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Get user data from Telegram
        const user = tg.initDataUnsafe.user;
        const userId = user ? user.id : null;

        // Prize configuration (matches spin_bot.py display_wheel)
        const prizes = [
            { name: "üéÅ iPhone 17 Pro Max", color: "#FF6B6B", chips: 0 },
            { name: "üíª MacBook Pro", color: "#4ECDC4", chips: 0 },
            { name: "‚åö Apple Watch Ultra", color: "#45B7D1", chips: 0 },
            { name: "üéß AirPods Pro", color: "#96CEB4", chips: 0 },
            { name: "üèÜ 500 Chips", color: "#FFD700", chips: 500 },
            { name: "üí∞ 250 Chips", color: "#FFA500", chips: 250 },
            { name: "üíé 100 Chips", color: "#87CEEB", chips: 100 },
            { name: "üíµ 50 Chips", color: "#90EE90", chips: 50 },
            { name: "ü™ô 20 Chips", color: "#DDA0DD", chips: 20 },
            { name: "üéØ 10 Chips", color: "#F0E68C", chips: 10 }
        ];

        let spinning = false;
        let availableSpins = 0;

        // Draw the wheel
        function drawWheel() {
            const wheel = document.getElementById('wheel');
            const segmentAngle = 360 / prizes.length;

            prizes.forEach((prize, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.background = prize.color;
                segment.style.transform = `rotate(${segmentAngle * index}deg) skewY(${-90 + segmentAngle}deg)`;
                segment.innerHTML = `<span style="transform: skewY(${90 - segmentAngle}deg) rotate(${segmentAngle/2}deg); display: block;">${prize.name}</span>`;
                wheel.appendChild(segment);
            });
        }

        // Load user spin data
        async function loadSpinData() {
            try {
                // Send request to bot to get user's available spins
                const response = await fetch('/api/get_spins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        init_data: tg.initData
                    })
                });

                const data = await response.json();
                availableSpins = data.available_spins || 0;

                document.getElementById('spinsInfo').innerHTML = `
                    üéØ Available Spins: <strong>${availableSpins}</strong>
                `;

                if (availableSpins === 0) {
                    document.getElementById('spinBtn').disabled = true;
                    document.getElementById('spinBtn').textContent = 'NO SPINS';
                }
            } catch (error) {
                console.error('Error loading spin data:', error);
                document.getElementById('spinsInfo').innerHTML = '‚ùå Error loading data';
            }
        }

        // Spin the wheel
        async function spinWheel() {
            if (spinning || availableSpins === 0) return;

            spinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('result').style.display = 'none';

            try {
                // Request spin result from backend
                const response = await fetch('/api/spin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        init_data: tg.initData,
                        spin_count: 1
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    alert(result.message || 'Error spinning wheel');
                    spinning = false;
                    document.getElementById('spinBtn').disabled = false;
                    return;
                }

                // Calculate winning segment
                const winningPrize = result.display_prize || prizes[0].name;
                const winningIndex = prizes.findIndex(p => p.name === winningPrize);
                const segmentAngle = 360 / prizes.length;
                const targetAngle = -(winningIndex * segmentAngle) + (segmentAngle / 2);
                const spinRotations = 5; // Number of full rotations
                const totalRotation = (360 * spinRotations) + targetAngle;

                // Spin animation
                const wheel = document.getElementById('wheel');
                wheel.style.transform = `rotate(${totalRotation}deg)`;

                // Wait for spin to complete
                setTimeout(() => {
                    // Show result
                    const resultDiv = document.getElementById('result');

                    if (result.milestone_prize) {
                        resultDiv.innerHTML = `
                            üéä <strong>JACKPOT!</strong> üéä<br>
                            ${result.milestone_prize.name}<br>
                            üí∞ ${result.milestone_prize.chips} CHIPS!<br>
                            <small>‚è≥ Pending admin approval</small>
                        `;
                        createConfetti();
                    } else {
                        resultDiv.innerHTML = `
                            ${winningPrize}<br>
                            <small>Keep spinning for prizes!</small>
                        `;
                    }

                    resultDiv.style.display = 'flex';

                    // Update spins
                    availableSpins = result.available_spins;
                    document.getElementById('spinsInfo').innerHTML = `
                        üéØ Available Spins: <strong>${availableSpins}</strong>
                    `;

                    spinning = false;

                    if (availableSpins > 0) {
                        document.getElementById('spinBtn').disabled = false;
                    } else {
                        document.getElementById('spinBtn').textContent = 'NO SPINS LEFT';
                    }

                    // Send result back to Telegram bot
                    tg.sendData(JSON.stringify(result));

                }, 4000);

            } catch (error) {
                console.error('Error spinning:', error);
                alert('Error processing spin. Please try again.');
                spinning = false;
                document.getElementById('spinBtn').disabled = false;
            }
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // Initialize
        drawWheel();
        loadSpinData();

        // Handle Telegram theme
        if (tg.colorScheme === 'dark') {
            document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
        }
    </script>
</body>
</html>
