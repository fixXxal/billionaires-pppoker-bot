<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Free Spins</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.2) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(76, 209, 55, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        h1 {
            color: white;
            font-size: 1.8em;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .spins-info {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            color: white;
            font-size: 1.1em;
        }

        .wheel-container {
            position: relative;
            width: 340px;
            height: 340px;
            margin: 20px auto;
        }

        .wheel-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            will-change: transform;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4),
                        0 0 60px rgba(255, 215, 0, 0.3),
                        0 0 100px rgba(255, 107, 107, 0.2);
        }

        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 35px solid #FFD700;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            z-index: 10;
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            border: 5px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5),
                        0 0 20px rgba(255, 215, 0, 0.5);
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .spin-controls {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .spin-option-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
            min-width: 60px;
        }

        .spin-option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .spin-option-btn:active {
            transform: scale(0.95);
        }

        .spin-option-btn:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .spin-all-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3),
                        0 0 30px rgba(255, 215, 0, 0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            touch-action: manipulation;
            flex: 1;
            min-width: 150px;
        }

        .spin-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.4),
                        0 0 40px rgba(255, 215, 0, 0.6);
        }

        .spin-all-btn:active {
            transform: scale(0.95);
        }

        .spin-all-btn:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            min-height: 60px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .prize-list {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px;
            margin-top: 20px;
            color: white;
            font-size: 0.85em;
            text-align: left;
        }

        .prize-list h3 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .prize-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 360px) {
            .wheel-container {
                width: 300px;
                height: 300px;
            }
            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ FREE SPINS üé∞</h1>

        <div class="spins-info" id="spinsInfo">
            Loading...
        </div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <div class="wheel-wrapper" id="wheelWrapper">
                <canvas id="wheelCanvas"></canvas>
            </div>
            <div class="center-circle">SPIN</div>
        </div>

        <div class="spin-controls">
            <button class="spin-option-btn" onclick="spinWheel(1)">1x</button>
            <button class="spin-option-btn" onclick="spinWheel(10)">10x</button>
            <button class="spin-option-btn" onclick="spinWheel(25)">25x</button>
            <button class="spin-option-btn" onclick="spinWheel(50)">50x</button>
            <button class="spin-option-btn" onclick="spinWheel(100)">100x</button>
            <button class="spin-all-btn" id="spinAllBtn" onclick="spinAll()">Spin All</button>
        </div>

        <div class="result" id="result"></div>

        <div class="prize-list">
            <h3>üéÅ Possible Prizes</h3>
            <div class="prize-item">üèÜ 500 Chips</div>
            <div class="prize-item">üí∞ 250 Chips</div>
            <div class="prize-item">üíé 100 Chips</div>
            <div class="prize-item">üíµ 50 Chips</div>
            <div class="prize-item">ü™ô 20 Chips</div>
            <div class="prize-item">üéØ 10 Chips</div>
            <div class="prize-item">üì± iPhone 17 Pro Max</div>
            <div class="prize-item">üíª MacBook Pro</div>
            <div class="prize-item">‚åö Apple Watch</div>
            <div class="prize-item">üéß AirPods Pro</div>
            <div class="prize-item">üîÑ Try Again</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const user = tg.initDataUnsafe.user;
        const userId = user ? user.id : null;

        // 16 segments - perfectly balanced and reordered
        const prizes = [
            { name: "500", display: "500 Chips", color: "#FFD700", textColor: "#000" },
            { name: "Try Again!", display: "Try Again", color: "#FF6B6B", textColor: "#fff" },
            { name: "50", display: "50 Chips", color: "#F38181", textColor: "#fff" },
            { name: "iphone", display: "iPhone 17", color: "#FFE66D", textColor: "#000", isImage: true, imgSrc: "spinnsimgss/iphone17promax.jpeg" },
            { name: "20", display: "20 Chips", color: "#95E1D3", textColor: "#000" },
            { name: "Try Again!", display: "Try Again", color: "#9D4EDD", textColor: "#fff" },
            { name: "100", display: "100 Chips", color: "#4ECDC4", textColor: "#000" },
            { name: "macbook", display: "MacBook Pro", color: "#5E60CE", textColor: "#fff", isImage: true, imgSrc: "spinnsimgss/macbookpro.jpeg" },
            { name: "10", display: "10 Chips", color: "#457B9D", textColor: "#fff" },
            { name: "Try Again!", display: "Try Again", color: "#06D6A0", textColor: "#fff" },
            { name: "250", display: "250 Chips", color: "#A8DADC", textColor: "#000" },
            { name: "airpods", display: "AirPods Pro", color: "#A8E6CF", textColor: "#000", isImage: true, imgSrc: "spinnsimgss/airpods.jpeg" },
            { name: "20", display: "20 Chips", color: "#95E1D3", textColor: "#000" },
            { name: "Try Again!", display: "Try Again", color: "#F4A261", textColor: "#000" },
            { name: "50", display: "50 Chips", color: "#F38181", textColor: "#fff" },
            { name: "watch", display: "Apple Watch", color: "#E63946", textColor: "#fff", isImage: true, imgSrc: "spinnsimgss/applewatchultra.jpeg" }
        ];

        // Preload images
        const images = {};
        function preloadImages() {
            prizes.forEach(prize => {
                if (prize.isImage && prize.imgSrc) {
                    const img = new Image();
                    img.src = prize.imgSrc;
                    img.onload = function() {
                        console.log('‚úÖ Image loaded:', prize.imgSrc);
                    };
                    img.onerror = function() {
                        console.error('‚ùå Image failed to load:', prize.imgSrc);
                    };
                    images[prize.name] = img;
                }
            });
        }

        let spinning = false;
        let availableSpins = 0;
        let currentRotation = 0;

        function updateSpinButtons() {
            // Update Spin All button text and visibility
            const spinAllBtn = document.getElementById('spinAllBtn');
            if (availableSpins > 0) {
                spinAllBtn.textContent = `Spin All (${availableSpins}x)`;
                spinAllBtn.style.display = 'block';
                spinAllBtn.disabled = spinning;
            } else {
                spinAllBtn.style.display = 'none';
            }

            // Show/hide buttons based on available spins
            const spinOptions = [1, 10, 25, 50, 100];
            document.querySelectorAll('.spin-option-btn').forEach((btn, idx) => {
                const requiredSpins = spinOptions[idx];
                if (availableSpins >= requiredSpins) {
                    btn.style.display = 'block';
                    btn.disabled = spinning;
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        function spinAll() {
            if (availableSpins > 0) {
                spinWheel(availableSpins);
            }
        }

        function drawPokerChip(ctx, x, y, size) {
            // Draw poker chip icon
            ctx.beginPath();
            ctx.arc(x, y, size, 0, 2 * Math.PI);
            ctx.fillStyle = '#2c3e50';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Draw inner circle
            ctx.beginPath();
            ctx.arc(x, y, size * 0.6, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();

            // Draw segments on edge
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI) / 4;
                ctx.beginPath();
                ctx.arc(x, y, size * 0.85, angle - 0.15, angle + 0.15);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();
            }
        }

        function drawWheel() {
            const canvas = document.getElementById('wheelCanvas');
            const ctx = canvas.getContext('2d');

            // Use higher resolution for sharp rendering
            const dpi = window.devicePixelRatio || 2;
            const size = 340;

            // Set canvas size with DPI scaling for crisp display
            canvas.width = size * dpi;
            canvas.height = size * dpi;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';

            // Scale context to match DPI
            ctx.scale(dpi, dpi);

            // Enable crisp image rendering
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2;
            const sliceAngle = (2 * Math.PI) / prizes.length;

            // Draw each slice
            prizes.forEach((prize, index) => {
                const startAngle = index * sliceAngle - Math.PI / 2;
                const endAngle = startAngle + sliceAngle;

                // Draw slice
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = prize.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Calculate text position
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + sliceAngle / 2);

                if (prize.name === "Try Again!") {
                    // Draw "Try Again!" text
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = prize.textColor;
                    ctx.font = 'bold 18px Arial';
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 2;
                    ctx.fillText("Try Again!", radius * 0.6, 0);
                } else if (prize.isImage) {
                    // Draw actual product image if loaded
                    const img = images[prize.name];
                    if (img && img.complete && img.naturalWidth > 0) {
                        const imgSize = 55;
                        const imgX = radius * 0.65 - imgSize / 2;
                        const imgY = -imgSize / 2;

                        // Clip to circle and draw image (no white background)
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(radius * 0.65, 0, imgSize / 2, 0, 2 * Math.PI);
                        ctx.clip();
                        ctx.drawImage(img, imgX, imgY, imgSize, imgSize);
                        ctx.restore();
                    } else {
                        // Fallback: draw colored circle with product emoji/text
                        ctx.beginPath();
                        ctx.arc(radius * 0.65, 0, 25, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.fill();

                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = prize.textColor;
                        ctx.font = 'bold 12px Arial';

                        // Show product icon
                        const displayText = prize.name === 'iphone' ? 'üì±' :
                                          prize.name === 'macbook' ? 'üíª' :
                                          prize.name === 'airpods' ? 'üéß' :
                                          prize.name === 'watch' ? '‚åö' : '?';
                        ctx.font = '28px Arial';
                        ctx.fillText(displayText, radius * 0.65, 0);
                    }
                } else {
                    // Draw poker chip + number
                    drawPokerChip(ctx, radius * 0.7, 0, 15);

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = prize.textColor;
                    ctx.font = 'bold 20px Arial';
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 2;
                    ctx.fillText(prize.name, radius * 0.45, 0);
                }

                ctx.restore();
            });

            // Draw outer golden border
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            const gradient = ctx.createLinearGradient(0, 0, size, size);
            gradient.addColorStop(0, '#FFD700');
            gradient.addColorStop(0.5, '#FFA500');
            gradient.addColorStop(1, '#FFD700');
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 10;
            ctx.stroke();

            // Add inner white border
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - 5, 0, 2 * Math.PI);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        async function loadSpinData() {
            try {
                console.log('Loading spin data for user:', userId);

                if (!userId) {
                    console.error('No user ID available!');
                    document.getElementById('spinsInfo').innerHTML = '‚ùå No user ID';
                    return;
                }

                const response = await fetch('https://billionaires-spins.up.railway.app/api/get_spins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        init_data: tg.initData
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Spin data received:', data);

                availableSpins = data.available_spins || 0;

                document.getElementById('spinsInfo').innerHTML = `
                    üéØ Available: <strong>${availableSpins}</strong> spins
                `;

                updateSpinButtons();
            } catch (error) {
                console.error('Error loading spins:', error);
                document.getElementById('spinsInfo').innerHTML = `‚ùå Error loading spins`;
            }
        }

        async function spinWheel(spinCount = 1) {
            if (spinning || availableSpins === 0 || spinCount > availableSpins) return;

            spinning = true;
            updateSpinButtons();
            document.getElementById('result').style.display = 'none';

            try {
                const response = await fetch('https://billionaires-spins.up.railway.app/api/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        init_data: tg.initData,
                        spin_count: spinCount
                    })
                });

                const result = await response.json();

                // Debug: Log what backend returns
                console.log('Backend result:', result);
                console.log('Display prize:', result.display_prize);

                if (!result.success) {
                    alert(result.message || 'Error');
                    spinning = false;
                    updateSpinButtons();
                    return;
                }

                // Handle spins - now all spins animate separately!
                if (result.results && result.results.length > 0) {
                    // Animate each spin one by one
                    animateMultipleSpins(result.results, result);
                } else {
                    // Fallback for single spin (backward compatibility)
                    const winningIndex = result.segment_index || 0;
                    const winningPrize = result.display_prize || prizes[0].display;

                    console.log('Backend selected segment:', winningIndex);
                    console.log('Prize:', winningPrize);
                    console.log('Wheel will show:', prizes[winningIndex].display)

                    const sliceAngle = 360 / prizes.length;
                    const targetAngle = -(winningIndex * sliceAngle);
                    const totalRotation = (360 * 5) + targetAngle;

                    const wheelWrapper = document.getElementById('wheelWrapper');
                    wheelWrapper.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                    currentRotation += totalRotation;
                    wheelWrapper.style.transform = `rotate(${currentRotation}deg)`;

                    setTimeout(() => {
                        showSingleResult(result, winningPrize, winningIndex);
                    }, 4000);
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error. Try again.');
                spinning = false;
                updateSpinButtons();
            }
        }

        async function animateMultipleSpins(spinResults, finalResult) {
            const resultDiv = document.getElementById('result');
            let totalChips = 0;
            const spinDelay = spinResults.length === 1 ? 4000 : 2000; // 4s for single, 2s for multi

            for (let i = 0; i < spinResults.length; i++) {
                const spin = spinResults[i];
                const winningIndex = spin.segment_index;
                const actualPrize = prizes[winningIndex];

                console.log(`Spin ${i + 1}/${spinResults.length}: Segment ${winningIndex} - ${actualPrize.display}`);

                // Animate wheel to this segment
                const sliceAngle = 360 / prizes.length;
                const targetAngle = -(winningIndex * sliceAngle);
                const totalRotation = (360 * 3) + targetAngle; // 3 rotations for multi-spin (faster)

                const wheelWrapper = document.getElementById('wheelWrapper');
                wheelWrapper.style.transition = `transform ${spinDelay / 1000}s cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
                currentRotation += totalRotation;
                wheelWrapper.style.transform = `rotate(${currentRotation}deg)`;

                // Show running result
                if (actualPrize.name !== "Try Again!") {
                    const match = spin.prize.match(/(\d+)/);
                    if (match) {
                        totalChips += parseInt(match[1]);
                    }
                }

                resultDiv.innerHTML = `
                    <div style="text-align: center;">
                        <strong>Spin ${i + 1}/${spinResults.length}</strong><br>
                        ${actualPrize.name === "Try Again!" ? 'üîÑ Try Again!' : `üéâ ${actualPrize.display}`}<br>
                        <div style="font-size: 0.9em; margin-top: 5px; color: #FFD700;">
                            üí∞ Total: ${totalChips} chips
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'flex';

                // Wait for animation to complete
                await new Promise(resolve => setTimeout(resolve, spinDelay));
            }

            // Show final summary
            setTimeout(() => {
                resultDiv.innerHTML = `
                    <div style="text-align: center;">
                        <strong style="font-size: 1.3em;">‚úÖ ${spinResults.length} SPINS COMPLETE!</strong><br>
                        <div style="font-size: 1.5em; margin: 10px 0; color: #FFD700;">
                            üí∞ ${totalChips} Total Chips
                        </div>
                        <div style="font-size: 0.9em;">
                            Keep spinning for more prizes!
                        </div>
                    </div>
                `;

                availableSpins = finalResult.available_spins;
                document.getElementById('spinsInfo').innerHTML = `
                    üéØ Available: <strong>${availableSpins}</strong> spins
                `;

                spinning = false;
                updateSpinButtons();

                tg.sendData(JSON.stringify(finalResult));
            }, 1000);
        }

        function showSingleResult(result, winningPrize, winningIndex) {
            const resultDiv = document.getElementById('result');

            // Get the ACTUAL prize from the wheel segment
            const actualPrize = prizes[winningIndex];
            const displayText = actualPrize.display;

            console.log('Showing result for segment:', winningIndex, 'Prize:', displayText);

            if (result.milestone_prize) {
                resultDiv.innerHTML = `
                    üéä <strong>WINNER!</strong> üéä<br>
                    ${result.milestone_prize.name}<br>
                    üí∞ ${result.milestone_prize.chips} CHIPS!<br>
                    <small>‚è≥ Pending approval</small>
                `;
            } else if (actualPrize.name === "Try Again!") {
                resultDiv.innerHTML = `
                    üîÑ <strong>Try Again!</strong><br>
                    <small>Better luck next spin!</small>
                `;
            } else {
                resultDiv.innerHTML = `
                    üéâ You won: <strong>${displayText}</strong><br>
                    <small>Keep spinning!</small>
                `;
            }

            resultDiv.style.display = 'flex';

            availableSpins = result.available_spins;
            document.getElementById('spinsInfo').innerHTML = `
                üéØ Available: <strong>${availableSpins}</strong> spins
            `;

            spinning = false;
            updateSpinButtons();

            tg.sendData(JSON.stringify(result));
        }

        function showBulkResults(result, spinCount) {
            const resultDiv = document.getElementById('result');

            // Calculate total chips won
            let totalChips = 0;
            let breakdown = {};

            if (result.results && Array.isArray(result.results)) {
                result.results.forEach(r => {
                    const prize = r.display_prize || r.prize;
                    breakdown[prize] = (breakdown[prize] || 0) + 1;

                    // Extract chip amount
                    const match = prize.match(/(\d+)/);
                    if (match) {
                        totalChips += parseInt(match[1]);
                    }
                });
            }

            // Build results HTML
            let resultsHTML = `
                <div style="text-align: center;">
                    <strong style="font-size: 1.3em;">üé∞ ${spinCount} SPINS COMPLETE! üé∞</strong><br>
                    <div style="font-size: 1.5em; margin: 10px 0; color: #FFD700;">
                        üí∞ ${totalChips.toLocaleString()} Total Chips
                    </div>
                    <div style="font-size: 0.9em; text-align: left; margin-top: 10px;">
            `;

            for (const [prize, count] of Object.entries(breakdown)) {
                resultsHTML += `<div>‚Ä¢ ${prize}: ${count}x</div>`;
            }

            resultsHTML += `</div></div>`;

            resultDiv.innerHTML = resultsHTML;
            resultDiv.style.display = 'flex';

            availableSpins = result.available_spins;
            document.getElementById('spinsInfo').innerHTML = `
                üéØ Available: <strong>${availableSpins}</strong> spins
            `;

            spinning = false;
            updateSpinButtons();

            tg.sendData(JSON.stringify(result));
        }

        // Initialize
        preloadImages();

        // Draw wheel initially
        drawWheel();

        // Redraw when images are loaded
        let loadedImages = 0;
        const totalImages = Object.keys(images).length;
        Object.values(images).forEach(img => {
            img.onload = () => {
                loadedImages++;
                if (loadedImages === totalImages) {
                    drawWheel(); // Redraw with images
                }
            };
        });

        loadSpinData();

        if (tg.colorScheme === 'dark') {
            document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)';
        }
    </script>
</body>
</html>
